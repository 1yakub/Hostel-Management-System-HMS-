name: Deploy to DigitalOcean

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Verify Live Application
        run: |
          echo "🔍 Verifying deployment status..."

          # Check if the application is responding
          HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" http://157.230.87.107/ || echo "0")

          if [ "$HTTP_STATUS" = "200" ]; then
            echo "✅ Application is live and responding!"
            echo "🌐 URL: http://157.230.87.107/"
            echo "📊 HTTP Status: $HTTP_STATUS"
          else
            echo "❌ Application not responding properly"
            echo "📊 HTTP Status: $HTTP_STATUS"
            exit 1
          fi

      - name: Application Health Check
        run: |
          echo "🏥 Running application health checks..."

          # Check if login page is accessible
          LOGIN_STATUS=$(curl -s -o /dev/null -w "%{http_code}" http://157.230.87.107/login || echo "0")
          echo "🔐 Login page status: $LOGIN_STATUS"

          # Check if homepage loads correctly
          HOMEPAGE_CONTENT=$(curl -s http://157.230.87.107/ | grep -o "<title>.*</title>" || echo "No title found")
          echo "📄 Homepage title: $HOMEPAGE_CONTENT"

          echo "✅ Health check completed successfully!"

      - name: Deployment Summary
        run: |
          echo "## 🚀 Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ✅ Status: SUCCESS" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Component | Status | Details |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|--------|---------|" >> $GITHUB_STEP_SUMMARY
          echo "| 🌐 **Live URL** | ✅ Active | [http://157.230.87.107/](http://157.230.87.107/) |" >> $GITHUB_STEP_SUMMARY
          echo "| 🖥️ **Server** | ✅ Online | DigitalOcean Droplet (multi-project-server) |" >> $GITHUB_STEP_SUMMARY
          echo "| 🔐 **Authentication** | ✅ Working | Login page accessible |" >> $GITHUB_STEP_SUMMARY
          echo "| 📊 **Environment** | ✅ Production | Laravel 11.x + MySQL + PHP 8.2 |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### 🎯 Demo Credentials:" >> $GITHUB_STEP_SUMMARY
          echo "- **Staff:** \`staff@example.com\` / \`password\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Guest:** \`guest@example.com\` / \`password\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**🕒 Deployed:** $(date)" >> $GITHUB_STEP_SUMMARY
