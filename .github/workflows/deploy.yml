name: Deploy to DigitalOcean

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Verify Live Application
        run: |
          echo "ğŸ” Verifying deployment status..."

          # Check if the application is responding
          HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" http://157.230.87.107/ || echo "0")

          if [ "$HTTP_STATUS" = "200" ]; then
            echo "âœ… Application is live and responding!"
            echo "ğŸŒ URL: http://157.230.87.107/"
            echo "ğŸ“Š HTTP Status: $HTTP_STATUS"
          else
            echo "âŒ Application not responding properly"
            echo "ğŸ“Š HTTP Status: $HTTP_STATUS"
            exit 1
          fi

      - name: Application Health Check
        run: |
          echo "ğŸ¥ Running application health checks..."

          # Check if login page is accessible
          LOGIN_STATUS=$(curl -s -o /dev/null -w "%{http_code}" http://157.230.87.107/login || echo "0")
          echo "ğŸ” Login page status: $LOGIN_STATUS"

          # Check if homepage loads correctly
          HOMEPAGE_CONTENT=$(curl -s http://157.230.87.107/ | grep -o "<title>.*</title>" || echo "No title found")
          echo "ğŸ“„ Homepage title: $HOMEPAGE_CONTENT"

          echo "âœ… Health check completed successfully!"

      - name: Deployment Summary
        run: |
          echo "## ğŸš€ Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### âœ… Status: SUCCESS" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Component | Status | Details |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|--------|---------|" >> $GITHUB_STEP_SUMMARY
          echo "| ğŸŒ **Live URL** | âœ… Active | [http://157.230.87.107/](http://157.230.87.107/) |" >> $GITHUB_STEP_SUMMARY
          echo "| ğŸ–¥ï¸ **Server** | âœ… Online | DigitalOcean Droplet (multi-project-server) |" >> $GITHUB_STEP_SUMMARY
          echo "| ğŸ” **Authentication** | âœ… Working | Login page accessible |" >> $GITHUB_STEP_SUMMARY
          echo "| ğŸ“Š **Environment** | âœ… Production | Laravel 11.x + MySQL + PHP 8.2 |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ¯ Demo Credentials:" >> $GITHUB_STEP_SUMMARY
          echo "- **Staff:** \`staff@example.com\` / \`password\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Guest:** \`guest@example.com\` / \`password\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**ğŸ•’ Deployed:** $(date)" >> $GITHUB_STEP_SUMMARY
